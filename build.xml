<?xml version="1.0" encoding="UTF-8"?>
<project name="apic-cicd" default="ci" basedir=".">

    <!-- ================== Properties (from Jenkins params) ================== -->
    <property name="api.dir" location="apis"/>
    <property name="product.dir" location="products"/>
    <property name="catalog.name" value="${CATALOG_NAME}"/>
    <property name="api.name" value="${API_NAME}"/>
    <property name="api.version" value="${API_VERSION}"/>
    <property name="product.name" value="${PRODUCT_NAME}"/>
    <property name="product.version" value="${PRODUCT_VERSION}"/>
    <property name="publish" value="${publish}"/>

    <!-- ================== Targets ================== -->
    <target name="ci" depends="login,validate,api-draft,product-draft,publish-product"/>

    <!-- Hardcoded login -->
    <target name="login">
        <echo message="ðŸ” Logging in to API Connect..." />
        <exec executable="apic" failonerror="true">
            <arg value="login"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--username"/>
            <arg value="umesh"/>
            <arg value="--password"/>
            <arg value="!n0r1t5@C"/>
            <arg value="--realm"/>
            <arg value="provider/default-idp-2"/>
        </exec>
    </target>

    <!-- Validate API YAML -->
    <target name="validate">
        <echo message="âœ… Validating API YAML for ${api.name}" />
        <exec executable="apic" failonerror="true">
            <arg value="validate"/>
            <arg value="${api.dir}/${api.name}.yaml"/>
        </exec>
    </target>

    <!-- =========================
         API Draft: Create or Update
         ========================= -->
    <target name="api-draft" depends="validate">
        <echo message="ðŸ“¦ Creating or Updating draft API ${api.name}:${api.version}..." />  

        <!-- List all APIs in the catalog -->
        <exec executable="apic" outputproperty="api.list" failonerror="true">
            <arg value="apis:list-all"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--org"/>
            <arg value="indusapi-np"/>
            <arg value="-c"/>
            <arg value="prod"/>
            <arg value="--scope"/>
            <arg value="catalog"/>
        </exec>

        <!-- Check if API exists -->
        <condition property="api.exists">
            <contains string="${api.list}" substring="${api.name}:${api.version}"/>
        </condition>

        <!-- Call create and update targets unconditionally -->
        <antcall target="api-create"/>
        <antcall target="api-update"/>
    </target>

    <!-- Create API draft -->
    <target name="api-create">
        <!-- Skip execution if API exists -->
        <fail message="API already exists, skipping create." if="api.exists"/>
        <echo message="ðŸ†• Creating new draft API ${api.name}:${api.version}" />
        <exec executable="apic" failonerror="true">
            <arg value="draft-apis:create"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--org"/>
            <arg value="indusapi-np"/>
            <arg value="${api.dir}/${api.name}.yaml"/>
        </exec>
    </target>

    <!-- Update API draft -->
    <target name="api-update">
        <!-- Skip execution if API does NOT exist -->
        <fail message="API does not exist, skipping update." unless="api.exists"/>
        <echo message="ðŸ”„ Updating existing draft API ${api.name}:${api.version}" />
        <exec executable="apic" failonerror="true">
            <arg value="draft-apis:update"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--org"/>
            <arg value="indusapi-np"/>
            <arg value="${api.name}:${api.version}"/>
            <arg value="${api.dir}/${api.name}.yaml"/>
        </exec>
    </target>

    <!-- =========================
         Product Draft: Create or Update
         ========================= -->
    <target name="product-draft">
        <echo message="ðŸ“¦ Creating or Updating draft Product ${product.name}:${product.version}" />  

        <!-- List all products in the catalog -->
        <exec executable="apic" outputproperty="product.list" failonerror="true">
            <arg value="products:list-all"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--org"/>
            <arg value="indusapi-np"/>
            <arg value="-c"/>
            <arg value="prod"/>
            <arg value="--scope"/>
            <arg value="catalog"/>
        </exec>

        <!-- Check if Product exists -->
        <condition property="product.exists">
            <contains string="${product.list}" substring="${product.name}:${product.version}"/>
        </condition>

        <!-- Call create and update targets unconditionally -->
        <antcall target="product-create"/>
        <antcall target="product-update"/>
    </target>

    <!-- Create Product draft -->
    <target name="product-create">
        <!-- Skip if product exists -->
        <fail message="Product already exists, skipping create." if="product.exists"/>
        <echo message="ðŸ†• Creating new draft Product ${product.name}:${product.version}" />
        <exec executable="apic" failonerror="true">
            <arg value="draft-products:create"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--org"/>
            <arg value="indusapi-np"/>
            <arg value="${product.dir}/${product.name}.yaml"/>
        </exec>
    </target>

    <!-- Update Product draft -->
    <target name="product-update">
        <!-- Skip if product does NOT exist -->
        <fail message="Product does not exist, skipping update." unless="product.exists"/>
        <echo message="ðŸ”„ Updating existing draft Product ${product.name}:${product.version}" />
        <exec executable="apic" failonerror="true">
            <arg value="draft-products:update"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--org"/>
            <arg value="indusapi-np"/>
            <arg value="${product.name}:${product.version}"/>
            <arg value="${product.dir}/${product.name}.yaml"/>
        </exec>
    </target>

    <!-- Publish Product (only if publish=true) -->
    <target name="publish-product" if="publish">
        <echo message="ðŸš€ Publishing Product ${product.name}:${product.version} to catalog ${catalog.name}" />
        <exec executable="apic" failonerror="true">
            <arg value="products:publish"/>
            <arg value="${product.dir}/${product.name}.yaml"/>
            <arg value="--catalog"/>
            <arg value="${catalog.name}"/>
        </exec>
    </target>

</project>
