<?xml version="1.0" encoding="UTF-8"?>
<project name="apic-cicd-pipeline" default="ci" basedir=".">

    <!-- ================== PROPERTIES ================== -->
    <property name="API_DIR" location="apis"/>
    <property name="PRODUCT_DIR" location="products"/>

    <!-- File paths are built directly from Jenkins params -->
    <property name="API_FILE" location="${API_DIR}/${API_NAME}.yaml"/>
    <property name="PRODUCT_FILE" location="${PRODUCT_DIR}/${PRODUCT_NAME}.yaml"/>

    <!-- ================== TARGETS ================== -->

    <target name="login">
        <echo message="🔐 Logging in to API Connect..."/>
        <exec executable="apic" failonerror="true">
            <arg line="login --server ${APIC_SERVER} --username ${APIC_USERNAME} --password ${APIC_PASSWORD} --realm provider/default-idp-2"/>
        </exec>
    </target>

    <target name="validate">
        <echo message="✅ Validating API YAML for ${API_NAME}"/>
        <exec executable="apic" failonerror="true">
            <arg line="validate ${API_FILE}"/>
        </exec>
    </target>

    <target name="api-process">
        <echo message="📦 Processing API ${API_NAME}..."/>
        <!-- First check if API already exists -->
        <exec executable="apic" failonerror="false" resultproperty="api.exists">
            <arg line="draft-apis:get --server ${APIC_SERVER} --org ${APIC_ORG} ${API_NAME}"/>
        </exec>

        <!-- Update if exists -->
        <condition property="api.exists.true">
            <equals arg1="${api.exists}" arg2="0"/>
        </condition>

        <antcall target="api-update" inheritall="true" inheritrefs="true" />
        <antcall target="api-create" inheritall="true" inheritrefs="true" />
    </target>

    <target name="api-create" unless="api.exists.true">
        <echo message="🆕 Creating draft API ${API_NAME}"/>
        <exec executable="apic" failonerror="true">
            <arg line="draft-apis:create --server ${APIC_SERVER} --org ${APIC_ORG} ${API_FILE}"/>
        </exec>
    </target>

    <target name="api-update" if="api.exists.true">
        <echo message="♻️ Updating draft API ${API_NAME}"/>
        <exec executable="apic" failonerror="true">
            <arg line="draft-apis:update --server ${APIC_SERVER} --org ${APIC_ORG} ${API_NAME} ${API_FILE}"/>
        </exec>
    </target>

    <target name="product-process">
        <echo message="📦 Processing Product ${PRODUCT_NAME}..."/>
        <exec executable="apic" failonerror="true">
            <arg line="draft-products:replace --server ${APIC_SERVER} --org ${APIC_ORG} ${PRODUCT_FILE}"/>
        </exec>
    </target>

    <target name="publish">
        <echo message="🚀 Publishing ${PRODUCT_NAME} to ${CATALOG_NAME}"/>
        <exec executable="apic" failonerror="true">
            <arg line="products:publish --server ${APIC_SERVER} --org ${APIC_ORG} --catalog ${CATALOG_NAME} ${PRODUCT_FILE}"/>
        </exec>
    </target>

    <target name="ci" depends="login,validate,api-process,product-process,publish">
        <echo message="✅ CI/CD Pipeline completed successfully."/>
    </target>

</project>
