<?xml version="1.0" encoding="UTF-8"?>
<project name="apic-cicd" default="ci" basedir=".">

    <!-- ================== Properties (from Jenkins params) ================== -->
    <property name="api.dir" location="apis"/>
    <property name="product.dir" location="products"/>

    <property name="catalog.name" value="${CATALOG_NAME}"/>
    <property name="api.name" value="${API_NAME}"/>
    <property name="api.version" value="${API_VERSION}"/>
    <property name="product.name" value="${PRODUCT_NAME}"/>
    <property name="product.version" value="${PRODUCT_VERSION}"/>
    <property name="publish" value="${publish}"/>

    <!-- ================== Targets ================== -->

    <target name="ci" depends="login,validate,api-draft,product-draft,publish-product"/>

    <!-- Hardcoded login only -->
    <target name="login">
        <echo message="🔐 Logging in to API Connect (hardcoded login, params still dynamic)..." />
        <exec executable="apic" failonerror="true">
            <arg value="login" />
            <arg value="--server" />
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com" />
            <arg value="--username" />
            <arg value="umesh" />
            <arg value="--password" />
            <arg value="!n0r1t5@C" />
            <arg value="--realm" />
            <arg value="provider/default-idp-2" />
        </exec>
    </target>

    <!-- Validate API YAML -->
    <target name="validate">
        <echo message="✅ Validating API YAML for ${api.name}" />
        <exec executable="apic" failonerror="true">
            <arg value="validate" />
            <arg value="${api.dir}/${api.name}.yaml" />
        </exec>
    </target>

    <!-- =========================
         API Draft: Create or Update
         ========================= -->
    <target name="api-draft" depends="validate">
        <echo message="📦 Creating or Updating draft API ${api.name}:${api.version}..." />

        <!-- List all APIs in the catalog -->
        <exec executable="apic" outputproperty="api.list" failonerror="true">
            <arg value="apis:list-all"/>
            <arg value="--scope"/>
            <arg value="catalog"/>
            <arg value="--catalog"/>
            <arg value="prod"/>
        </exec>
     
</project>
