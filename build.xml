<?xml version="1.0" encoding="UTF-8"?>
<project name="apic-cicd" default="ci" basedir=".">

    <!-- ================== Properties (from Jenkins params) ================== -->
    <property name="api.dir" location="apis"/>
    <property name="product.dir" location="products"/>

    <property name="catalog.name" value="${CATALOG_NAME}"/>
    <property name="api.name" value="${API_NAME}"/>
    <property name="product.name" value="${PRODUCT_NAME}"/>
    <property name="publish" value="${publish}"/>

    <!-- ================== Targets ================== -->

    <target name="ci" depends="login,validate,api-draft,product-draft,publish-product"/>

    <!-- Hardcoded login only -->
    <target name="login">
        <echo message="ðŸ” Logging in to API Connect (hardcoded login, params still dynamic)..." />
        <exec executable="apic" failonerror="true">
            <arg value="login" />
            <arg value="--server" />
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com" />
            <arg value="--username" />
            <arg value="umesh" />
            <arg value="--password" />
            <arg value="!n0r1t5@C" />
            <arg value="--realm" />
            <arg value="provider/default-idp-2" />
        </exec>
    </target>

    <!-- Validate API YAML -->
    <target name="validate">
        <echo message="âœ… Validating API YAML for ${api.name}" />
        <exec executable="apic" failonerror="true">
            <arg value="validate" />
            <arg value="${api.dir}/${api.name}.yaml" />
        </exec>
    </target>

    <!-- Create or Update Draft API -->
    <target name="api-draft">
        <echo message="ðŸ“¦ Creating or Updating draft API ${api.name}" />
        <exec executable="apic" failonerror="false" resultproperty="api.create.result">
            <arg value="draft-apis:create" />
            <arg value="--server" />
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com" />
            <arg value="--org" />
            <arg value="indusapi-np" />
            <arg value="${api.dir}/${api.name}.yaml" />
        </exec>

        <condition property="api.create.failed">
            <not>
                <equals arg1="${api.create.result}" arg2="0"/>
            </not>
        </condition>

        <antcall target="api-update" />
    </target>

    <!-- Update Draft API -->
    <target name="api-update" if="api.create.failed">
        <echo message="ðŸ”„ Updating existing draft API ${api.name}" />
        <exec executable="apic" failonerror="true">
            <arg value="draft-apis:update" />
            <arg value="--server" />
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com" />
            <arg value="--org" />
            <arg value="indusapi-np" />
            <arg value="${api.dir}/${api.name}.yaml" />
        </exec>
    </target>

    <!-- Create or Update Draft Product -->
    <target name="product-draft">
        <echo message="ðŸ“¦ Creating or Updating draft Product ${product.name}" />
        <exec executable="apic" failonerror="false" resultproperty="product.create.result">
            <arg value="draft-products:create" />
            <arg value="--server" />
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com" />
            <arg value="--org" />
            <arg value="indusapi-np" />
            <arg value="${product.dir}/${product.name}.yaml" />
        </exec>

        <condition property="product.create.failed">
            <not>
                <equals arg1="${product.create.result}" arg2="0"/>
            </not>
        </condition>

        <antcall target="product-update" />
    </target>

    <!-- Update Draft Product -->
    <target name="product-update" if="product.create.failed">
        <echo message="ðŸ”„ Updating existing draft Product ${product.name}" />
        <exec executable="apic" failonerror="true">
            <arg value="draft-products:update" />
            <arg value="--server" />
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com" />
            <arg value="--org" />
            <arg value="indusapi-np" />
            <arg value="${product.dir}/${product.name}.yaml" />
        </exec>
    </target>

    <!-- Publish Product (only if publish=true) -->
    <target name="publish-product" if="publish">
        <echo message="ðŸš€ Publishing Product ${product.name} to catalog ${catalog.name}" />
        <exec executable="apic" failonerror="true">
            <arg value="products:publish" />
            <arg value="${product.dir}/${product.name}.yaml" />
            <arg value="--catalog" />
            <arg value="${catalog.name}" />
        </exec>
    </target>

</project>
